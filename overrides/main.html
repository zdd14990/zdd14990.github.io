{% extends "base.html" %}

{% block scripts %}
  {{ super() }}

  <style>
    /* 亮色模式背景 */
    body[data-md-color-scheme="default"]::before {
        background-image: url('{{ base_url }}/assets/site_bg_light.jpg');
    }
    /* 暗色模式背景 */
    body[data-md-color-scheme="slate"]::after {
        background-image: url('{{ base_url }}/assets/site_bg_dark.jpg');
    }
  </style>

  <script>
  (function() {
      // 定义音频路径 (利用 base_url 修复路径错误)
      var audioPath = "{{ base_url }}/assets/bgm.mp3";

      // 1. 全局音频单例
      if (!window.myGlobalAudio) {
          window.myGlobalAudio = new Audio(audioPath);
          window.myGlobalAudio.loop = true; 
          window.myGlobalAudio.volume = 0.5; 
      }

      // 2. 渲染 UI (固定在右下角)
      var oldBtn = document.getElementById('my-simple-player');
      if (oldBtn) oldBtn.remove();

      var playerContainer = document.createElement('div');
      playerContainer.id = 'my-simple-player';
      playerContainer.className = 'simple-player-floating';
      playerContainer.innerHTML = `
          <div class="player-icon" id="player-btn" title="点击播放/暂停">
              <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M9 18V5l12-2v13"></path>
                  <circle cx="6" cy="18" r="3"></circle>
                  <circle cx="18" cy="16" r="3"></circle>
              </svg>
          </div>
      `;
      document.body.appendChild(playerContainer);

      // 3. 交互逻辑
      var btnIcon = document.getElementById('player-btn');
      var audio = window.myGlobalAudio;

      // 检查音频文件是否加载成功
      audio.onerror = function() {
          console.error("音频加载失败，请检查路径:", audioPath);
          alert("BGM 加载失败，请检查 assets/bgm.mp3 是否存在或文件名大小写是否正确。");
      };

      if (!audio.paused) {
          btnIcon.classList.add('playing');
      }

      btnIcon.onclick = function() {
          if (audio.paused) {
              var p = audio.play();
              if (p !== undefined) {
                  p.then(_ => btnIcon.classList.add('playing'))
                   .catch(e => {
                       console.error("播放受阻:", e);
                       // 很多时候是因为浏览器策略，必须用户交互
                   });
              }
          } else {
              audio.pause();
              btnIcon.classList.remove('playing');
          }
      };
  })();
  </script>
{% endblock %}