{% extends "base.html" %}

{% block scripts %}
  {{ super() }}

  <script>
  (function() {
      // =================================================
      // 1. 全局音频单例 (保证切换页面音乐不断)
      // =================================================
      if (!window.myGlobalAudio) {
          window.myGlobalAudio = new Audio("{{ base_url }}/assets/bgm.mp3");
          window.myGlobalAudio.loop = true; 
          window.myGlobalAudio.volume = 0.5; 
      }

      // =================================================
      // 2. 渲染 UI (固定在右下角)
      // =================================================
      // 移除旧实例，防止重复
      var oldBtn = document.getElementById('my-simple-player');
      if (oldBtn) oldBtn.remove();

      var playerContainer = document.createElement('div');
      playerContainer.id = 'my-simple-player';
      playerContainer.className = 'simple-player-floating';
      playerContainer.innerHTML = `
          <div class="player-icon" id="player-btn" title="点击播放/暂停">
              <svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M9 18V5l12-2v13"></path>
                  <circle cx="6" cy="18" r="3"></circle>
                  <circle cx="18" cy="16" r="3"></circle>
              </svg>
          </div>
      `;
      document.body.appendChild(playerContainer);

      // =================================================
      // 3. 纯粹的点击交互
      // =================================================
      var btnIcon = document.getElementById('player-btn');
      var audio = window.myGlobalAudio;

      // 同步状态：如果切换页面时音乐正在放，按钮保持旋转
      if (!audio.paused) {
          btnIcon.classList.add('playing');
      }

      // 点击事件：只有播放和暂停，没有其他逻辑
      btnIcon.onclick = function() {
          if (audio.paused) {
              var p = audio.play();
              if (p !== undefined) {
                  p.then(_ => btnIcon.classList.add('playing'))
                   .catch(e => console.error("播放受阻:", e));
              }
          } else {
              audio.pause();
              btnIcon.classList.remove('playing');
          }
      };

  })();
  </script>
{% endblock %}